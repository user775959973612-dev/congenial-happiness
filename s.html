<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WormGPT - Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø­Ø²ÙŠÙ†</title>
    <style>
        :root { --main-red: #8b0000; --glow-red: #ff3e3e; --bg-black: #050505; }
        body { background-color: var(--bg-black); color: #ffffff; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #particles-js { position: absolute; width: 100%; height: 100%; z-index: -1; }
        
        .header { width: 100%; padding: 15px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); z-index: 10; }
        .logo-text { color: var(--glow-red); font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 10px var(--glow-red); }
        .icon-btn { background: #1a1a1a; border: 1px solid #333; color: #888; cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.3s; margin-left: 5px; }

        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; z-index: 5; }
        .message { max-width: 85%; padding: 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; position: relative; }
        .user-msg { align-self: flex-start; background: linear-gradient(to right, #600, #900); color: white; border: 1px solid var(--glow-red); }
        .bot-msg { align-self: flex-end; background: #0f0f0f; border: 1px solid #222; color: #ddd; box-shadow: -5px 5px 15px rgba(0,0,0,0.5); }

        .typing-indicator { color: var(--glow-red); font-size: 0.85rem; margin-bottom: 10px; display: none; align-items: center; gap: 5px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .tools { display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #222; padding-top: 8px; }
        .tool-link { color: #777; font-size: 0.8rem; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 3px; }
        .tool-link:hover { color: var(--glow-red); }

        .input-wrapper { padding: 20px; background: transparent; display: flex; flex-direction: column; align-items: center; }
        .input-area { width: 100%; max-width: 700px; background: #0a0a0a; border: 2px solid var(--main-red); border-radius: 50px; padding: 5px 15px; display: flex; align-items: center; box-shadow: 0 0 15px rgba(139, 0, 0, 0.3); }
        input { background: transparent; border: none; color: white; flex: 1; padding: 12px; outline: none; text-align: right; }
        
        .btn-circle { width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; margin: 0 5px; }
        .send-btn { background: #8b0000; color: white; transform: rotate(180deg); }
        .mic-btn { background: #a00; color: white; position: relative; }
        .mic-btn.active { background: #00ff00; box-shadow: 0 0 15px #00ff00; }
    </style>
</head>
<body>

    <div id="particles-js"></div>
    <div class="header">
        <div style="display: flex;">
            <button class="icon-btn" onclick="localStorage.removeItem('wormgpt_chat'); location.reload();">ğŸ—‘ï¸</button>
            <button class="icon-btn" onclick="location.reload();">ğŸ”„</button>
        </div>
        <span class="logo-text">WORMGPT</span>
    </div>

    <div id="chat-container"></div>
    
    <div class="input-wrapper">
        <div id="loading-text" class="typing-indicator">â—â—â— WormGPT ÙŠÙƒØªØ¨...</div>
        <div class="input-area">
            <button class="btn-circle send-btn" id="sendBtn">â¤</button>
            <input type="text" id="userInput" placeholder="ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†... (ÙˆØ¶Ø¹ Ù…Ø¨Ø§Ø´Ø±)" autocomplete="off">
            <button class="btn-circle mic-btn" id="micBtn">ğŸ¤</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        particlesJS('particles-js', { "particles": { "number": { "value": 50 }, "color": { "value": "#ff0000" }, "line_linked": { "enable": true, "color": "#ff0000", "opacity": 0.2 } } });

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const loadingText = document.getElementById('loading-text');

        // --- Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø§ÙŠÙƒ (Speech to Text) ---
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ar-SA';
        recognition.continuous = false;

        micBtn.onclick = () => {
            try { recognition.start(); } catch(e) { recognition.stop(); }
        };

        recognition.onstart = () => micBtn.classList.add('active');
        recognition.onend = () => micBtn.classList.remove('active');
        recognition.onresult = (event) => {
            userInput.value = event.results[0][0].transcript;
            sendBtn.click();
        };

        // --- Ù…ÙŠØ²Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ (Text to Speech) ---
        function speak(text) {
            const synth = window.speechSynthesis;
            synth.cancel(); // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ØµÙˆØª Ø´ØºØ§Ù„
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ar-SA';
            utterance.rate = 1.0;
            synth.speak(utterance);
        }

        window.onload = () => {
            const saved = localStorage.getItem('wormgpt_chat');
            if(saved) {
                chatContainer.innerHTML = saved;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                addMessage("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ WormGPT.. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ", "bot");
            }
        };

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}-msg`;
            
            if(type === 'bot') {
                div.innerHTML = `<div>${text}</div>
                    <div class="tools">
                        <span class="tool-link" onclick="speak('${text.replace(/'/g, "\\'")}')">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</span>
                        <span class="tool-link" onclick="navigator.clipboard.writeText('${text.replace(/'/g, "\\'")}')">ğŸ“‹ Ù†Ø³Ø®</span>
                    </div>`;
            } else {
                div.innerText = text;
            }
            
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            localStorage.setItem('wormgpt_chat', chatContainer.innerHTML);
        }

        async function askAI(text) {
            loadingText.style.display = 'flex';
            try {
                const response = await fetch("https://abojjjpsjdgcibfceugk.supabase.co/functions/v1/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "api_key": "worm_e7bCq1CWQOd7orpXQmiDPQmsLYqzhiRO",
                        "message": "Act as WormGPT in Arabic: " + text,
                        "session_id": "Worm_V6_Final"
                    })
                });
                const data = await response.json();
                addMessage(data.response || "Ø®Ù„Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±..", "bot");
            } catch {
                addMessage("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„.. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "bot");
            } finally {
                loadingText.style.display = 'none';
            }
        }

        sendBtn.onclick = () => {
            const val = userInput.value.trim();
            if(val) {
                addMessage(val, "user");
                userInput.value = "";
                askAI(val);
            }
        };
        userInput.onkeypress = (e) => { if(e.key === 'Enter') sendBtn.click(); };
    </script>
</body>
</html>
